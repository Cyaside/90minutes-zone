{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 pt-28 pb-24">
  <div class="mb-6 flex items-center justify-between">
    <a href="{% url 'main:show_main' %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-700 text-sm font-medium hover:bg-gray-50 transition shadow-sm">
      <span class="text-lg">←</span> <span>Back</span>
    </a>
    <div id="owner-actions" class="flex items-center gap-3 hidden">
      <a id="edit-link" href="#" class="px-4 py-2 rounded-lg bg-gray-800 text-white text-sm font-medium hover:bg-gray-900 transition focus:outline-none focus:ring-2 focus:ring-gray-500/50">Edit</a>
      <a id="delete-link" href="#" class="px-4 py-2 rounded-lg bg-red-600 text-white text-sm font-medium hover:bg-red-700 transition focus:outline-none focus:ring-2 focus:ring-red-500/50">Delete</a>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loading-state" class="relative bg-white/90 backdrop-blur border border-gray-200 rounded-2xl shadow-xl p-10 flex flex-col items-center text-center">
    <svg class="animate-spin h-10 w-10 text-gray-700 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-gray-600">Loading product detail...</p>
  </div>

  <!-- Error State -->
  <div id="error-state" class="relative bg-white/90 backdrop-blur border border-red-200 rounded-2xl shadow-xl p-10 overflow-hidden hidden">
    <div class="text-center">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Failed to load product</h3>
      <button id="retry-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white text-sm font-medium hover:bg-red-700 transition">Retry</button>
    </div>
  </div>

  <!-- Content State -->
  <div id="product-wrapper" class="relative bg-white/90 backdrop-blur border border-gray-200 rounded-2xl shadow-xl p-10 overflow-hidden hidden">
    <div class="relative">
  <h1 id="product-name" class="text-4xl font-bold mb-4 text-gray-900 flex items-center tracking-tight"><span class="sr-only">Product name loading</span></h1>
      <div id="badge-row" class="flex flex-wrap items-center text-sm text-gray-600 mb-6 gap-3"></div>
      <div id="thumbnail-container" class="rounded-xl overflow-hidden border border-gray-200 shadow-sm mb-8 hidden">
        <img id="product-thumbnail" src="" alt="Product Thumbnail" class="w-full max-h-[420px] object-cover">
      </div>
      <div class="prose max-w-none text-gray-700 mb-8 leading-relaxed">
        <p id="product-description" class="whitespace-pre-line"></p>
      </div>
      <div class="text-2xl font-semibold text-gray-900 mb-2">Price: <span id="product-price" class="text-black-600"></span></div>
      <div class="text-sm text-gray-500" id="product-meta"></div>
    </div>
  </div>
</div>

<script>
// --- Configuration ---
const PRODUCT_ID = "{{ product.id|default:'' }}"; 
const PRODUCT_DETAIL_ENDPOINT_TEMPLATE = `{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`;
const PRODUCT_DETAIL_ENDPOINT = PRODUCT_DETAIL_ENDPOINT_TEMPLATE.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID || window.location.pathname.split('/').filter(Boolean).pop());


const loadingState = document.getElementById('loading-state');
const errorState = document.getElementById('error-state');
const retryBtn = document.getElementById('retry-btn');
const wrapper = document.getElementById('product-wrapper');
const nameEl = document.getElementById('product-name');
const badgeRow = document.getElementById('badge-row');
const thumbContainer = document.getElementById('thumbnail-container');
const thumbImg = document.getElementById('product-thumbnail');
const descEl = document.getElementById('product-description');
const priceEl = document.getElementById('product-price');
const metaEl = document.getElementById('product-meta');
const ownerActions = document.getElementById('owner-actions');
const editLink = document.getElementById('edit-link');
const deleteLink = document.getElementById('delete-link');

// State
function showState(state) {
  loadingState.classList.toggle('hidden', state !== 'loading');
  errorState.classList.toggle('hidden', state !== 'error');
  wrapper.classList.toggle('hidden', state !== 'ready');
}


function formatRupiah(value) {
  if (value === null || value === undefined) return '-';
  return new Intl.NumberFormat('id-ID').format(value);
}

// Render product JSON into DOM
function renderProduct(p) {
  document.title = `${p.name} - Product Detail`;
  nameEl.textContent = p.name || 'Unnamed Product';

  // Badges
  badgeRow.innerHTML = '';
  if (p.category_display) {
    const cat = document.createElement('span');
    cat.className = 'inline-flex items-center px-3 py-1 rounded-full bg-gray-100 border border-gray-200 text-gray-700';
    cat.textContent = p.category_display;
    badgeRow.appendChild(cat);
  }
  if (p.is_featured) {
    const feat = document.createElement('span');
    feat.className = 'inline-flex items-center px-3 py-1 rounded-full bg-yellow-300 text-black text-xs font-semibold shadow-inner';
    feat.textContent = 'Featured';
    badgeRow.appendChild(feat);
  }
  if ((p.views||0) > 25) {
    const popular = document.createElement('span');
    popular.className = 'inline-flex items-center px-3 py-1 rounded-full bg-red-100 border border-red-200 text-red-700 text-xs';
    popular.textContent = 'Popular';
    badgeRow.appendChild(popular);
  }

  // Thumbnail
  if (p.thumbnail) {
    thumbImg.src = p.thumbnail;
    thumbImg.alt = p.name;
    thumbContainer.classList.remove('hidden');
  } else {
    thumbContainer.classList.add('hidden');
  }

  // Description
  descEl.textContent = p.description || '';

  // Price
  priceEl.textContent = 'Rp ' + formatRupiah(p.price);

  // Meta (views & owner)
  metaEl.textContent = `Views: ${p.views || 0} • Seller: ${p.user_username || 'Unknown'}`;

  // Owner Actions 
  const currentUserId = document.documentElement.getAttribute('data-user-id');
  if (currentUserId && p.user_id && currentUserId === String(p.user_id)) {
    ownerActions.classList.remove('hidden');
    editLink.href = `{% url 'main:edit_product' 0 %}`.replace('/0/', `/${p.id}/`);
    deleteLink.href = `{% url 'main:delete_product' 0 %}`.replace('/0/', `/${p.id}/`);
  }
}

async function loadProduct() {
  try {
    showState('loading');
    const res = await fetch(PRODUCT_DETAIL_ENDPOINT, { headers: { 'Accept': 'application/json' }});
    if (!res.ok) throw new Error('Network response not ok');
    const data = await res.json();
    renderProduct(data);
    showState('ready');
  } catch (err) {
    console.error('Error loading product detail:', err);
    showState('error');
  }
}

retryBtn?.addEventListener('click', loadProduct);
loadProduct();
</script>
{% endblock %}